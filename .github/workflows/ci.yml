name: CI - Backend

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'
  IMAGE_NAME: dr-ocp-admin-be

jobs:
  test:
    name: Testes Unitários
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restaurar dependências
      run: dotnet restore DrOcupacional.Backend.sln
      
    - name: Build solução
      run: dotnet build DrOcupacional.Backend.sln --configuration Release --no-restore
      
    - name: Executar testes
      id: test
      run: |
        dotnet test DrOcupacional.Backend.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage" || echo "⚠️ Nenhum projeto de teste encontrado ou testes falharam"
        # Verificar se arquivos .trx foram gerados
        if find . -name "*.trx" -type f | grep -q .; then
          echo "has_test_results=true" >> $GITHUB_OUTPUT
        else
          echo "has_test_results=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
      
    - name: Publicar resultados dos testes
      if: always() && steps.test.outputs.has_test_results == 'true'
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: '**/*.trx'
        check_name: 'Resultados dos Testes Unitários'
        
    - name: Aviso - Nenhum resultado de teste
      if: always() && steps.test.outputs.has_test_results == 'false'
      run: echo "⚠️ Nenhum arquivo de resultado de teste (.trx) foi encontrado. Isso pode indicar que não há projetos de teste na solução."

  docker-build-push:
    name: Build e Push Docker
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login no Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Preparar tags
      id: tags
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
        RUN_ID: ${{ github.run_id }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        SHORT_SHA=${GITHUB_SHA::7}
        
        # Criar lista de tags
        TAGS="${DOCKER_USERNAME}/${IMAGE_NAME}:${BRANCH_NAME}"
        TAGS="${TAGS},${DOCKER_USERNAME}/${IMAGE_NAME}:${BRANCH_NAME}-${SHORT_SHA}"
        TAGS="${TAGS},${DOCKER_USERNAME}/${IMAGE_NAME}:${RUN_ID}"
        TAGS="${TAGS},${DOCKER_USERNAME}/${IMAGE_NAME}:${RUN_ID}-${BRANCH_NAME}"
        
        if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
          TAGS="${TAGS},${DOCKER_USERNAME}/${IMAGE_NAME}:latest"
        fi
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "Tags criadas: ${TAGS}"
          
    - name: Build e Push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

